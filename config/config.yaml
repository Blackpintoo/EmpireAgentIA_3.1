mt5:
  account: 11535481
  password: "Lapintade96@?"
  server: VantageInternational-Demo
  terminal_path: "C:\\Program Files\\MetaTrader 5\\terminal64.exe"
  autostart:
    enabled: true
    process_name: "terminal64.exe"
    monday_start: "05:30"
    friday_stop: "23:00"
    check_interval_minutes: 5

telegram:
  enabled: true
  token: 7969631468:AAHzPL6iCB9kO0K1iPtVeTkP-L2FevVdttc
  chat_id: 5277012507
  send_status_minutely: false
  send_trade_validation_only: false
  # Notifications autorisées (réduites pour éviter le spam):
  # - daily_digest: Résumé quotidien des performances
  # - trade_event: Ouverture/fermeture de trades (NEW_TRADE, CLOSE_TRADE, MOVE_BE, TP_HIT)
  # - error: Erreurs critiques et arrêts du système
  allow_kinds: [daily_digest, trade_event, error]
  send_daily_digest: true
  daily_digest_times: ["06:00", "10:00", "14:00", "18:00", "21:00"]   # Europe/Zurich - 5x par jour

# ============================================================
# API EXTERNES (Phase 5) - Ajouté le 2025-11-29
# ============================================================
external_apis:
  # Finnhub : Calendrier économique (GRATUIT - 60 appels/min)
  # Inscription : https://finnhub.io/
  finnhub:
    enabled: true
    api_key: "${FINNHUB_API_KEY}"  # Variable d'environnement
    cache_ttl: 3600  # Cache 1 heure
    freeze_period_minutes: 15  # ±15 min autour des événements HIGH
    events_to_track:
      - FOMC
      - NFP
      - CPI
      - GDP
      - ECB
      - BOE
      - BOJ

  # Alpha Vantage : News Sentiment (GRATUIT - 25 appels/jour)
  # Inscription : https://www.alphavantage.co/
  alpha_vantage:
    enabled: true
    api_key: "${ALPHA_VANTAGE_API_KEY}"  # Variable d'environnement
    cache_ttl: 1800  # Cache 30 minutes
    rate_limit: 25   # Appels par jour
    min_relevance: 0.3  # Ignorer news peu pertinentes

  # Fear & Greed Index : Sentiment crypto (GRATUIT - sans clé)
  # API : https://api.alternative.me/fng/
  fear_greed:
    enabled: true
    cache_ttl: 3600  # Cache 1 heure
    use_as_filter: false  # NE PAS filtrer, juste contexte
    use_as_context: true  # Utiliser comme contexte global

engine:
  timezone: "Europe/Zurich"    # utilisé par le planning et les sessions
  default_deviation: 30         # déviation par défaut (peut être surchargée par symbole via profiles.yaml)
  max_symbols_parallel: 5
  weekdays_only: false          # Désactivé pour permettre le trading crypto le week-end
  weekend_crypto_only: true     # Uniquement les cryptos le week-end (forex/indices/commodities bloqués)

timeframes:
  orchestrator: 60
  scalping: M1
  swing: H1

multi_timeframes:
  enabled: true
  tfs: [D1, H4, H1, M30, M5, M1]
  tf_weights:
    D1: 1.2
    H4: 1.1
    H1: 1.0
    M30: 0.9
    M5: 0.8
    M1: 0.7

execution:
  slippage_points: 10             # tolérance slippage (en points MT5)
  max_retries: 3                  # essais sur retcodes récupérables
  backoff_seconds: [0.5, 1.0, 2]  # exponentiel simple
  circuit_breaker:
    window_seconds: 60            # fenêtre de décompte des erreurs
    max_errors: 5                 # stop envoi d’ordres si > max dans la fenêtre
  price_refresh_on_requote: true  # resynchroniser le prix lors de REQUOTE/PRICE_CHANGED

backtest:
   gating:
     pf_min: 1.30
     maxdd_pct_max: 0.12      # 12%
     expectancy_min: 0.0
     sharpe_min: 1.2
     sortino_min: 1.0
     rr_proxy_min: 1.5
     min_trades: 200

# ══════════════════════════════════════════════════════════════════════════════
# SOLUTION 4: Filtre de volatilité (OPTIMISATION 2025-12-13)
# Bloque les trades dans des conditions de marché défavorables
# ══════════════════════════════════════════════════════════════════════════════
volatility_filter:
  enabled: true

  # Spike ATR - bloque si ATR actuel > X fois la moyenne
  atr_spike_threshold: 2.0
  atr_lookback_periods: 20

  # Spread - bloque si spread > X% de l'ATR
  max_spread_atr_ratio: 0.3

  # Gap - bloque si gap > X fois l'ATR
  gap_threshold_atr: 0.5

  # Sessions à éviter (heures UTC) - OPTIMISÉ 2025-12-24 après audit
  # Heures toxiques identifiées: 01h, 02h, 05h, 18h, 19h, 20h, 21h, 22h
  avoid_low_liquidity: true
  low_liquidity_hours_utc: [0, 1, 2, 3, 4, 5, 18, 19, 20, 21, 22, 23]

  # Blackout autour des news
  news_blackout_enabled: true
  news_blackout_minutes: 30

  # Override par type d'actif
  asset_overrides:
    crypto:
      atr_spike_threshold: 2.5
      avoid_low_liquidity: false    # Crypto 24/7
    forex:
      news_blackout_minutes: 45     # Plus prudent sur forex
    commodities:
      atr_spike_threshold: 1.8      # Or/Argent plus sensibles
      news_blackout_minutes: 60

# ══════════════════════════════════════════════════════════════════════════════
# OPTIMISATION 2025-12-13: Outils d'analyse avancés (ÉTAPE 2)
# ══════════════════════════════════════════════════════════════════════════════
advanced_analysis:
  # Outil 1: Volume Profile / VWAP Agent
  volume_profile_enabled: true
  volume_profile:
    lookback_bars: 100
    value_area_pct: 0.70
    num_bins: 50

  # Outil 2: Market Regime Detector
  market_regime_enabled: true
  market_regime:
    adx_trend_threshold: 25.0      # ADX > 25 = tendance
    adx_strong_trend: 40.0         # ADX > 40 = tendance forte
    min_confidence_to_block: 0.6   # Confiance minimum pour bloquer un trade

  # Outil 3: MTF Confluence Analyzer (RENFORCÉ 2026-01-06)
  mtf_confluence_enabled: true
  mtf_confluence:
    min_alignment_ratio: 0.7       # AUGMENTÉ 0.6→0.7 - 70% des TF doivent être alignés
    require_higher_tf_confirm: true
    block_counter_trend: true      # NOUVEAU - Bloquer trades contre-tendance D1/H4
    full_alignment_bonus: 0.3
    higher_tf_priority: ["D1", "H4"]  # TF prioritaires pour validation

  # Outil 4: Advanced Sentiment Analyzer
  sentiment_enabled: true
  sentiment:
    extreme_long_threshold: 75.0   # > 75% retail long = signal contrarian SHORT
    extreme_short_threshold: 25.0  # < 25% retail long = signal contrarian LONG
    min_score_to_block: 0.7        # Score minimum pour bloquer un trade

  # Outil 5: Inter-Market Correlation
  inter_market_enabled: true
  inter_market:
    correlation_period: 20
    strong_correlation_threshold: 0.7
    divergence_threshold: 0.4

paths:
  audit_dir: data/audit
     
orchestrator:
  votes_required: 2              # AUGMENTÉ 1→2 pour plus de confirmation (OPTIMISATION 2025-12-13)
  push_only_on_master: true

  # ══════════════════════════════════════════════════════════════════════════
  # SOLUTION 1: Seuils de qualité augmentés (OPTIMISATION 2025-12-24)
  # ══════════════════════════════════════════════════════════════════════════
  min_score_for_proposal: 8.0    # AUGMENTÉ 6.0→8.0 - Exiger des signaux très forts
  min_confluence: 5              # AUGMENTÉ 4→5 - Minimum 5 agents en accord

  # ══════════════════════════════════════════════════════════════════════════
  # SOLUTION 2: Ratio R:R minimum requis (OPTIMISATION 2025-12-13)
  # MODIFIE 2025-12-30: Augmente de 1.5 -> 1.8 pour ameliorer Profit Factor
  # ══════════════════════════════════════════════════════════════════════════
  min_rr_required: 1.8           # AUGMENTE 1.5->1.8 - Meilleur R:R exige

  # ══════════════════════════════════════════════════════════════════════════
  # SOLUTION 5: Limites de trading journalières (OPTIMISATION 2025-12-13)
  # MISE A JOUR 2026-01-06: Ajout allocation par symbole
  # ══════════════════════════════════════════════════════════════════════════
  max_trades_per_day: 10         # RÉDUIT 15→10 - Max 10 trades/jour total
  cooldown_after_loss_minutes: 30  # Pause 30 min après une perte
  max_consecutive_losses_pause: 3  # Pause si 3 pertes consécutives

  # Allocation par symbole - limite le nombre de trades par jour par symbole
  symbol_daily_limits:
    enabled: true
    default_max_per_symbol: 2     # Par défaut: max 2 trades/jour/symbole
    limits:
      NAS100: 3                   # Moteur principal - plus de trades
      SP500: 3                    # Moteur principal
      AUDUSD: 2                   # Standard
      XAUUSD: 2                   # Standard

  # ══════════════════════════════════════════════════════════════════════════
  # COOLDOWN - Éviter les rafales de trades (FIX 2025-12-17)
  # Problème détecté: 4 rafales de trades sur UK100/GBPUSD en < 10 min
  # ══════════════════════════════════════════════════════════════════════════
  cooldown:
    enabled: true
    after_trade_min: 15          # AUGMENTÉ 5→15 min après chaque trade
    after_loss_min: 30           # Pause 30 min après une perte
    after_win_min: 10            # AUGMENTÉ 2→10 min après un gain
    after_reject_min: 5          # AUGMENTÉ 3→5 min après un rejet
    after_streak_n: 3            # Nombre de pertes consécutives pour pause longue
    after_streak_min: 120        # AUGMENTÉ 60→120 min après 3 pertes consec

  # ══════════════════════════════════════════════════════════════════════════
  # BUDGET HORAIRE - Éviter la concentration des trades (FIX 2025-12-17)
  # Problème détecté: 83% des trades entre 14:00-16:00 UTC
  # ══════════════════════════════════════════════════════════════════════════
  max_trades_per_hour: 5         # NOUVEAU - Max 5 trades par heure

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 1: EVENT GUARD - Protection annonces économiques (2025-12-17)
  # Bloque les trades autour des annonces HIGH/MEDIUM impact
  # ══════════════════════════════════════════════════════════════════════════
  event_guard:
    enabled: true
    high_window_before: 30       # Minutes avant annonce HIGH
    high_window_after: 30        # Minutes après annonce HIGH
    medium_window_before: 15     # Minutes avant annonce MEDIUM
    medium_window_after: 15      # Minutes après annonce MEDIUM
    alert_before_high_min: 60    # Alerte Telegram 60min avant HIGH
    alert_before_medium_min: 30  # Alerte Telegram 30min avant MEDIUM

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 2: SENTIMENT AVANCÉ V2 - FinBERT (2025-12-17)
  # Remplace TextBlob par analyse financière avancée
  # ══════════════════════════════════════════════════════════════════════════
  sentiment_v2:
    enabled: true
    use_finbert: true            # Utiliser FinBERT si disponible
    fallback_textblob: true      # Fallback sur TextBlob si FinBERT indisponible
    bullish_threshold: 0.3       # Seuil pour signal bullish
    bearish_threshold: -0.3      # Seuil pour signal bearish
    min_confidence: 0.5          # Confiance minimum pour signal

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 3: SCORE COMPOSITE - Unification des signaux (2025-12-17)
  # Combine agents + volume profile + inter-market + sentiment
  # ══════════════════════════════════════════════════════════════════════════
  composite_score:
    enabled: true
    weight_agents: 0.50          # 50% score des agents IA
    weight_volume_profile: 0.20  # 20% Volume Profile (VWAP, POC)
    weight_inter_market: 0.15    # 15% Corrélation inter-marchés
    weight_sentiment: 0.15       # 15% Sentiment news
    enable_sl_tp_optimization: true  # Optimiser SL/TP via Volume Profile

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 4: INTER-MARKET GUARD - Blocage flux macro (2025-12-17)
  # Bloque les trades contre les flux macro dominants
  # ══════════════════════════════════════════════════════════════════════════
  inter_market_guard:
    enabled: true
    min_confidence_to_block: 0.5  # Confiance minimum pour bloquer
    cache_ttl_minutes: 15         # Cache des analyses

  position_policy:
    allow_stacking: false       # 1 position max par sens
    max_open_per_side: 1
    max_open_total: 2           # Maximum 2 positions simultanées
    allow_opposite: false       # pas de hedge simultané

  anti_spam:
    per_bar_only: true
    cooldown_minutes: 5         # AUGMENTÉ 2→5 min pour meilleure qualité (OPTIMISATION 2025-12-13)
    price_delta_bps: 5          # AUGMENTÉ 2→5 pour éviter micro-variations
    confidence_delta: 0.05      # AUGMENTÉ 0.03→0.05
    avoid_if_open_position: true  # RÉTABLI true - éviter surexposition (OPTIMISATION 2025-12-13)

  near_miss_alert: false

  weighted:
    enabled: true
    threshold: 3.0              # AUGMENTÉ 1.5→3.0 pour signaux plus forts (OPTIMISATION 2025-12-13)
    weights:
      TechnicalAgent: 1.2
      SwingAgent: 1.0
      ScalpingAgent: 0.8        # AUGMENTÉ de 0.6→0.8 (PHASE 1)
      StructureAgent: 1.1       # AJOUTÉ pour l'agent Structure
      SmartMoneyAgent: 1.0      # AJOUTÉ pour l'agent Smart Money
      NewsAgent: 0.8
      SentimentAgent: 0.6

  notifications:
    daily_report_enabled: true

risk:
  timezone: Europe/Zurich
  reset_limits_daily: true
  daily_loss_limit_pct: 0.02   # 2% — ajuste si tu veux 1%: 0.01
  daily_goal_mode: auto
  monthly_goal_chf_by_phase:
    phase1: 500
    phase1_max: 2000
    phase2: 5000
    phase3: 10000
  trading_days_per_month: 22

  max_consecutive_losses: 3
  allow_multiple_positions: true   # MODIFIÉ false→true pour permettre positions multiples (PHASE 1)
  max_parallel_positions: 2        # AUGMENTÉ de 1→2 (PHASE 1)

  tiers:
    - name: phase1
      equity_min: 0
      equity_max: 5000
      risk_per_trade_pct: 0.01     # 0.5% au départ
      max_daily_loss_pct: 2.0
      max_parallel_positions: 1
    - name: phase2
      equity_min: 5000
      equity_max: 15000
      risk_per_trade_pct: 0.015
      max_daily_loss_pct: 3.0
      max_parallel_positions: 2
    - name: phase3
      equity_min: 15000
      equity_max: 99999999
      risk_per_trade_pct: 0.02
      max_daily_loss_pct: 4.0
      max_parallel_positions: 2

  compounding:
    mode: weekly
    day_of_week: MON

optuna:
  n_trials: 50
  timeout: 600

logging:
  level: DEBUG

scalping:
  params:
    timeframe: M1
    session_hours: [7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]  # Europe/Zurich
    max_spread: 100
    max_trades_per_hour: 10           # AUGMENTÉ de 6 → 10
    rsi_period: 7
    ema_period: 21
    atr_period: 14
    rsi_overbought: 65                # ASSOUPLI de 70 → 65 (plus de signaux SHORT)
    rsi_oversold: 35                  # ASSOUPLI de 30 → 35 (plus de signaux LONG)
    tp_mult: 2.0
    sl_mult: 1.5
    vol_window: 20
    vol_spike_ratio: 1.2
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest

swing:
  params:
    timeframe: H1
    lookback: 200
    ema_period: 50
    rsi_period: 14
    atr_period: 14
    trend_rsi_long: 50                # ASSOUPLI de 52 → 50
    trend_rsi_short: 50               # ASSOUPLI de 48 → 50
    range_rsi_long: 35                # ASSOUPLI de 32 → 35
    range_rsi_short: 65               # ASSOUPLI de 68 → 65
    trend_tp_mult: 3.5                # RÉDUIT de 4.0 → 3.5 (meilleur RR)
    trend_sl_mult: 2.0
    range_tp_mult: 2.0
    range_sl_mult: 1.5
    slope_level: 0.04                 # RÉDUIT de 0.05 → 0.04 (détecte plus de tendances)
    atr_level_val: 0.015
    eco_event_minutes: 60
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest

technical:
  params:
    ema_period: 50
    rsi_period: 14
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    obv_window: 10
    atr_period: 14
    # ══════════════════════════════════════════════════════════════════════════
    # SOLUTION 2: Amélioration R:R (OPTIMISATION 2025-12-13)
    # ══════════════════════════════════════════════════════════════════════════
    tp_mult: 3.0                      # AUGMENTÉ 2.5→3.0 - TP plus loin
    sl_mult: 1.5                      # RÉDUIT 2.0→1.5 - SL plus serré
    votes_required: 2                 # AUGMENTÉ 1→2 - Plus de confirmation
    rsi_overbought: 65                # RESSERRÉ 60→65 - Moins de faux signaux
    rsi_oversold: 35                  # RESSERRÉ 40→35 - Moins de faux signaux
    macd_eps: 0.001                   # AUGMENTÉ 0.0008→0.001 - Seuil MACD plus strict
    obv_z_deadzone: 0.5               # AUGMENTÉ 0.35→0.5 - Zone morte OBV plus large
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest

news:
  params:
    send_realtime: false              # Désactivé - seuls trade_event et daily_digest
    news_feeds:
      - https://cryptopanic.com/feed/news/
      - https://www.coindesk.com/arc/outboundfeeds/rss/
      - https://news.google.com/rss/search?q=bitcoin
      - https://www.reuters.com/markets/companies/crypto/
      - https://dailyhodl.com/feed/
      - https://cointelegraph.com/rss
      - https://fr.cryptowatchnews.com/feed/
    min_articles: 5
    request_timeout: 6
    max_retries: 2
    backoff_seconds: 2
    max_per_feed: 15
    source_weight:
      coindesk: 2
      cryptopanic: 1
      google: 1
      reuters: 3
      bloomberg: 3
    keywords_bullish: [etf, adoption, regulation, bullish, uptrend, buy, growth, rally, approval, partnership, institutional, invest, expansion]
    keywords_bearish: [hack, ban, scam, bearish, downtrend, sell, collapse, fraud, "regulation ban", lawsuit, liquidation, delisting]
    sentiment_threshold: 0.15
    keyword_weight: 2.0
    signal_threshold: 2
    lookback_hours: 12
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest
  digest:
    enabled: true
    time: "11:00"
    timezone: Europe/Zurich
    top_n: 8
    include_scores: true

fundamental:
  blackout:
    enabled: false
  params:
    calendar_api_url: https://calendar-api.fxstreet.com/events
    major_events: [FOMC, CPI, NFP, ECB, employment, inflation, interest rate, GDP, PMI, retail sales, unemployment, trade balance]
    asset_event_map:
      USD: [FOMC, CPI, NFP, employment, inflation, interest rate, GDP, PMI, retail sales]
      EUR: [ECB, inflation, unemployment, GDP, PMI, trade balance]
      GBP: [BOE, GDP, CPI, PMI, employment]
      JPY: [BOJ, GDP, CPI, PMI]
      CHF: [SNB, GDP, CPI]
    sens_map: { better: bullish, worse: bearish }
    wait_minutes: 30
    only_high_impact: true
    lookback_minutes: 180
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest
    use_forecast_diff_pct: true
    diff_pct_threshold: 0.3
    reverse_on_negative: true

sentiment:
  params:
    fg_weight: 0.5
    twitter_weight: 0.3
    google_weight: 0.2
    neutral_fg: 50
    upper_threshold: 0.4
    lower_threshold: -0.4
    notify_telegram: false            # Désactivé - seuls trade_event et daily_digest

whale:
  enabled: false  # DÉSACTIVÉ : Connecteurs non implémentés (onchain_listener, cex_tracker = stubs) - Sera réactivé en Phase 5
  min_trust: 0.6
  min_signal: 0.55
  ewma_alpha: 0.2
  allow_in_vol_spike: false
  latency_ms_max: 15000
  slippage_bps_max: 25
  feeds:
    onchain:
      enabled: true
      providers: [etherscan, arbitrum, bscscan]
      poll_seconds: 15
    cex:
      enabled: true
      venues: [binance, okx, bybit]
      ws_url: wss://whales.example/ws
    social:
      enabled: true
      sources: [twitter, mirror, news]
  storage:
    decisions_csv: data/whales_decisions.csv
    cache_db: store/whales.db

agents:
  # Agents actifs (avec sources de données fonctionnelles)
  - scalping       # RSI/EMA/ATR - Fonctionne
  - swing          # Tendance EMA - Fonctionne
  - technical      # MACD/RSI/ATR - Fonctionne
  - structure      # BOS/CHOCH - Fonctionne
  - smart_money    # FVG/Order Blocks - Fonctionne

  # Agents RÉACTIVÉS en Phase 5 avec API externes (2025-11-29)
  - news           # ✅ RÉACTIVÉ - Alpha Vantage News Sentiment
  - sentiment      # ✅ RÉACTIVÉ - Fear & Greed Index
  - fundamental    # ✅ RÉACTIVÉ - Finnhub Economic Calendar (utilisé via macro)
  - macro          # ✅ ACTIF - Gating macro + Finnhub Calendar

  # Agents DÉSACTIVÉS (implémentation complexe - Phase 6 future)
  # - whale        # Connecteurs on-chain/CEX non implémentés (onchain_listener, cex_tracker)

broker_costs:
  commission_per_lot: 8.0
  point_value_per_lot: 1.0
  spread_points: 25
  slippage_points_entry: 2
  slippage_points_exit: 2
